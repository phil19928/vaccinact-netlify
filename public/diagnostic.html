<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>VaccinAct ‚Äî Diagnostic</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,600;700&family=Manrope:wght@400;500;600;700&display=swap");

      :root {
        --max: 1200px;
        --bg: #f7f4ef;
        --surface: #fffdf9;
        --ink: #171717;
        --muted: #4c4c4c;
        --light-text: #6a655d;
        
        --primary: #0f6f5c;
        --primary-dark: #0b5a4a;
        --success: #16a34a;
        --warning: #f59e0b;
        --danger: #dc2626;
        --info: #3b82f6;
        
        --border: #e3ded5;
        --border-light: #eee6dc;
        --bg-light: #f6f3ee;
        
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 16px;
        
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 16px 40px rgba(12, 12, 12, 0.08);
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: "Manrope", sans-serif;
        margin: 0;
        padding: 24px;
        color: var(--ink);
        background: radial-gradient(900px 420px at 10% -10%, #ffe9bf 0, transparent 60%),
          radial-gradient(900px 420px at 90% 0%, #d9f3ec 0, transparent 60%), var(--bg);
        line-height: 1.6;
      }

      .container {
        max-width: var(--max);
        margin: 0 auto;
      }

      /* Header */
      .page-header {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 24px 28px;
        margin-bottom: 24px;
        box-shadow: var(--shadow-lg);
        animation: rise 420ms ease both;
      }

      h1 {
        margin: 0 0 6px;
        font-family: "Fraunces", serif;
        font-size: 32px;
        letter-spacing: 0.2px;
      }

      .subtitle {
        margin: 0 0 18px;
        color: var(--muted);
        font-size: 14px;
      }

      /* Form Section */
      .form-section {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 24px 28px;
        margin-bottom: 24px;
        box-shadow: var(--shadow-md);
        animation: rise 500ms ease both;
      }

      fieldset {
        border: 1px solid var(--border-light);
        border-radius: var(--radius-md);
        padding: 16px;
        margin: 14px 0;
        background: #fff;
        box-shadow: var(--shadow-sm);
      }

      legend {
        padding: 0 8px;
        font-weight: 700;
        font-size: 15px;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 12px;
      }

      .col-12 { grid-column: span 12; }
      .col-6 { grid-column: span 6; }
      .col-4 { grid-column: span 4; }
      .col-3 { grid-column: span 3; }

      label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        color: #2d2d2d;
        margin: 0 0 6px;
      }

      input[type="text"],
      input[type="date"],
      select,
      textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #d7d0c7;
        border-radius: 10px;
        font-size: 14px;
        background: #fff;
        font-family: inherit;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(15, 111, 92, 0.18);
      }

      textarea {
        min-height: 70px;
        resize: vertical;
      }

      .hint {
        font-size: 12px;
        color: var(--light-text);
        margin-top: 4px;
      }

      button {
        padding: 12px 20px;
        border: 0;
        border-radius: var(--radius-md);
        cursor: pointer;
        font-weight: 700;
        font-size: 15px;
        font-family: inherit;
        background: var(--primary);
        color: #fffdf8;
        box-shadow: 0 10px 20px rgba(15, 111, 92, 0.2);
        transition: transform 0.15s ease, background 0.2s ease;
      }

      button:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      button.secondary {
        background: #6b7280;
        box-shadow: 0 10px 20px rgba(107, 114, 128, 0.15);
      }

      button.secondary:hover {
        background: #4b5563;
      }

      .actions {
        display: flex;
        gap: 12px;
        align-items: center;
        margin: 18px 0 8px;
      }

      .status-text {
        font-size: 14px;
        color: var(--light-text);
        font-weight: 500;
      }

      /* Result Sections */
      .result-container {
        display: none;
        animation: rise 600ms ease both;
      }

      .result-container.visible {
        display: block;
      }

      .section {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 24px 28px;
        margin-bottom: 20px;
        box-shadow: var(--shadow-md);
      }

      .section-title {
        font-family: "Fraunces", serif;
        font-size: 24px;
        margin: 0 0 18px;
        color: var(--ink);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .section-title .emoji {
        font-size: 28px;
      }

      /* Meta Header */
      .meta-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        padding: 16px;
        background: var(--bg-light);
        border-radius: var(--radius-md);
        font-size: 14px;
      }

      .meta-item strong {
        display: block;
        font-weight: 600;
        color: var(--muted);
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
      }

      /* Cards */
      .card {
        background: #fff;
        border: 1px solid var(--border-light);
        border-radius: var(--radius-md);
        padding: 18px 20px;
        margin-bottom: 14px;
        box-shadow: var(--shadow-sm);
        transition: box-shadow 0.2s ease, transform 0.2s ease;
      }

      .card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 12px;
        gap: 12px;
      }

      .card-title {
        font-weight: 700;
        font-size: 16px;
        margin: 0;
        color: var(--ink);
      }

      .card-content {
        font-size: 14px;
        line-height: 1.6;
      }

      /* Badges */
      .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
      }

      .badge-primary {
        background: #d1fae5;
        color: #065f46;
      }

      .badge-warning {
        background: #fef3c7;
        color: #92400e;
      }

      .badge-danger {
        background: #fee2e2;
        color: #991b1b;
      }

      .badge-info {
        background: #dbeafe;
        color: #1e40af;
      }

      .badge-neutral {
        background: #f3f4f6;
        color: #374151;
      }

      /* Alerts */
      .alert {
        border-left: 4px solid;
        padding: 14px 16px;
        border-radius: var(--radius-sm);
        margin-bottom: 12px;
        font-size: 14px;
      }

      .alert-danger {
        background: #fef2f2;
        border-color: var(--danger);
        color: #7f1d1d;
      }

      .alert-warning {
        background: #fffbeb;
        border-color: var(--warning);
        color: #78350f;
      }

      .alert-info {
        background: #eff6ff;
        border-color: var(--info);
        color: #1e3a8a;
      }

      .alert-title {
        font-weight: 700;
        margin-bottom: 6px;
      }

      /* Table */
      .table-wrapper {
        overflow-x: auto;
        border-radius: var(--radius-md);
        border: 1px solid var(--border-light);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      th {
        background: var(--bg-light);
        padding: 12px 14px;
        text-align: left;
        font-weight: 700;
        color: var(--muted);
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid var(--border);
      }

      td {
        padding: 12px 14px;
        border-bottom: 1px solid var(--border-light);
      }

      tr:last-child td {
        border-bottom: none;
      }

      tr:hover {
        background: #fafaf9;
      }

      /* Sources */
      .sources {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid var(--border-light);
      }

      .sources-label {
        font-size: 12px;
        font-weight: 700;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 6px;
      }

      .source-item {
        display: block;
        font-size: 13px;
        color: var(--light-text);
        margin-bottom: 4px;
        line-height: 1.5;
      }

      .source-item strong {
        color: var(--ink);
        font-weight: 600;
      }

      .source-snippet {
        font-style: italic;
        color: var(--muted);
      }

      /* Lists */
      .bullet-list {
        margin: 8px 0;
        padding-left: 20px;
      }

      .bullet-list li {
        margin-bottom: 6px;
        font-size: 14px;
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 32px 20px;
        color: var(--muted);
        font-style: italic;
      }

      /* Raw JSON Toggle */
      .json-wrapper {
        display: none;
        margin-top: 20px;
      }

      .json-wrapper.visible {
        display: block;
      }

      pre {
        background: #1e293b;
        color: #e2e8f0;
        border: 1px solid #334155;
        padding: 16px;
        border-radius: var(--radius-md);
        overflow: auto;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        font-size: 13px;
        line-height: 1.5;
        max-height: 600px;
      }

      /* Animations */
      @keyframes rise {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Responsive */
      @media (max-width: 768px) {
        body {
          padding: 16px;
        }

        .grid {
          grid-template-columns: 1fr;
        }

        .col-12,
        .col-6,
        .col-4,
        .col-3 {
          grid-column: 1 / -1;
        }

        h1 {
          font-size: 26px;
        }

        .section-title {
          font-size: 20px;
        }

        .meta-grid {
          grid-template-columns: 1fr;
        }
      }

      @media (prefers-reduced-motion: reduce) {
        * {
          animation: none !important;
          transition: none !important;
        }
      }

      /* Print Styles */
      @media print {
        body {
          background: white;
          padding: 0;
        }

        .form-section,
        .actions,
        button {
          display: none;
        }

        .section {
          page-break-inside: avoid;
          box-shadow: none;
          border: 1px solid #ccc;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <!-- Header -->
      <div class="page-header">
        <h1>VaccinAct ‚Äî Diagnostic Vaccinal</h1>
        <p class="subtitle">
          Diagnostic bas√© exclusivement sur le document source via RAG (file_search)
          <span class="badge badge-neutral">document-only</span>
        </p>
      </div>

      <!-- Form Section -->
      <div class="form-section">
        <form id="vaccinForm">
          <fieldset>
            <legend>üìã Informations essentielles du patient</legend>
            <div class="grid">
              <div class="col-4">
                <label for="patient_age_range">Tranche d'√¢ge *</label>
                <select id="patient_age_range" name="patient_age_range" required>
                  <option value="">‚Äî s√©lectionner ‚Äî</option>
                  <option value="0-1">0‚Äì1 an</option>
                  <option value="2-5">2‚Äì5 ans</option>
                  <option value="6-17">6‚Äì17 ans</option>
                  <option value="18-25">18‚Äì25 ans</option>
                  <option value="26-45">26‚Äì45 ans</option>
                  <option value="46-65">46‚Äì65 ans</option>
                  <option value="65+">65+ ans</option>
                </select>
              </div>

              <div class="col-4">
                <label for="patient_sex">Sexe *</label>
                <select id="patient_sex" name="patient_sex" required>
                  <option value="">‚Äî s√©lectionner ‚Äî</option>
                  <option value="F">F</option>
                  <option value="M">M</option>
                  <option value="Autre/NSP">Autre/NSP</option>
                </select>
              </div>

              <div class="col-4">
                <label for="patient_pregnancy_status_or_project">Statut grossesse</label>
                <select id="patient_pregnancy_status_or_project" name="patient_pregnancy_status_or_project">
                  <option value="">‚Äî</option>
                  <option value="non">non</option>
                  <option value="projet">projet de grossesse</option>
                  <option value="enceinte_T1">enceinte T1</option>
                  <option value="enceinte_T2">enceinte T2</option>
                  <option value="enceinte_T3">enceinte T3</option>
                  <option value="postpartum">post-partum</option>
                </select>
              </div>

              <div class="col-6">
                <label for="patient_profession_risk_exposure">Profession / exposition</label>
                <select id="patient_profession_risk_exposure" name="patient_profession_risk_exposure">
                  <option value="">‚Äî</option>
                  <option value="RAS">RAS</option>
                  <option value="soignant">soignant</option>
                  <option value="petite_enfance">petite enfance</option>
                  <option value="laboratoire">laboratoire / biom√©dical</option>
                  <option value="contact_animaux">contact animaux</option>
                  <option value="autre">autre</option>
                </select>
              </div>

              <div class="col-6">
                <label for="patient_travel_plan_country_date">Voyage pr√©vu</label>
                <input
                  type="text"
                  id="patient_travel_plan_country_date"
                  name="patient_travel_plan_country_date"
                  placeholder="Ex: Br√©sil, mars 2026"
                />
              </div>

              <div class="col-12">
                <label for="vax_history_doses_count_per_vaccine">Historique vaccinal (r√©sum√©)</label>
                <textarea
                  id="vax_history_doses_count_per_vaccine"
                  name="vax_history_doses_count_per_vaccine"
                  placeholder="Ex: DTP: 3 doses, derni√®re 2021; ROR: 1 dose 2002; Covid: 3 doses; Grippe: annuel"
                ></textarea>
                <div class="hint">R√©sum√© simplifi√© des vaccins re√ßus avec nombre de doses approximatif</div>
              </div>
            </div>
          </fieldset>

          <div class="actions">
            <button id="submitBtn" type="submit">üîç Lancer le diagnostic</button>
            <span id="status" class="status-text"></span>
          </div>
        </form>
      </div>

      <!-- Result Container -->
      <div id="resultContainer" class="result-container">
        <!-- Meta Header -->
        <div class="section" id="metaSection">
          <h2 class="section-title"><span class="emoji">‚ÑπÔ∏è</span> Informations du diagnostic</h2>
          <div id="metaContent"></div>
        </div>

        <!-- Recommended Vaccines -->
        <div class="section" id="vaccinesSection" style="display: none">
          <h2 class="section-title"><span class="emoji">üíâ</span> Vaccins recommand√©s</h2>
          <div id="vaccinesContent"></div>
        </div>

        <!-- Catchup Schedule -->
        <div class="section" id="catchupSection" style="display: none">
          <h2 class="section-title"><span class="emoji">üìÖ</span> Plan de rattrapage</h2>
          <div id="catchupContent"></div>
        </div>

        <!-- Contraindications -->
        <div class="section" id="contraindicationsSection" style="display: none">
          <h2 class="section-title"><span class="emoji">‚ö†Ô∏è</span> Contre-indications et pr√©cautions</h2>
          <div id="contraindicationsContent"></div>
        </div>

        <!-- Practical Advice -->
        <div class="section" id="adviceSection" style="display: none">
          <h2 class="section-title"><span class="emoji">üí°</span> Conseils pratiques</h2>
          <div id="adviceContent"></div>
        </div>

        <!-- Patient Report -->
        <div class="section" id="patientReportSection" style="display: none">
          <h2 class="section-title"><span class="emoji">üë§</span> R√©sum√© pour le patient</h2>
          <div id="patientReportContent"></div>
        </div>

        <!-- GP Report -->
        <div class="section" id="gpReportSection" style="display: none">
          <h2 class="section-title"><span class="emoji">ü©∫</span> R√©sum√© pour le m√©decin traitant</h2>
          <div id="gpReportContent"></div>
        </div>

        <!-- Limitations -->
        <div class="section" id="limitationsSection" style="display: none">
          <h2 class="section-title"><span class="emoji">‚ö°</span> Limitations</h2>
          <div id="limitationsContent"></div>
        </div>

        <!-- References -->
        <div class="section" id="referencesSection" style="display: none">
          <h2 class="section-title"><span class="emoji">üìö</span> Sources documentaires</h2>
          <div id="referencesContent"></div>
        </div>

        <!-- Raw JSON Toggle -->
        <div class="section">
          <button id="toggleJson" class="secondary">Voir JSON brut (debug)</button>
          <div id="jsonWrapper" class="json-wrapper">
            <pre id="rawJson"></pre>
          </div>
        </div>
      </div>
    </div>

    <script>
      // DOM Elements
      const form = document.getElementById("vaccinForm");
      const submitBtn = document.getElementById("submitBtn");
      const statusEl = document.getElementById("status");
      const resultContainer = document.getElementById("resultContainer");
      const toggleJsonBtn = document.getElementById("toggleJson");
      const jsonWrapper = document.getElementById("jsonWrapper");
      const rawJsonEl = document.getElementById("rawJson");

      // Toggle JSON
      toggleJsonBtn.addEventListener("click", () => {
        jsonWrapper.classList.toggle("visible");
        toggleJsonBtn.textContent = jsonWrapper.classList.contains("visible")
          ? "Masquer JSON brut"
          : "Voir JSON brut (debug)";
      });

      // Form Submit
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        submitBtn.disabled = true;
        statusEl.textContent = "üîÑ Appel en cours...";
        resultContainer.classList.remove("visible");

        const fd = new FormData(form);
        const payload = {
          patient_age_range: fd.get("patient_age_range") || "",
          patient_sex: fd.get("patient_sex") || "",
          patient_pregnancy_status_or_project: fd.get("patient_pregnancy_status_or_project") || "",
          patient_profession_risk_exposure: fd.get("patient_profession_risk_exposure") || "",
          patient_travel_plan_country_date: fd.get("patient_travel_plan_country_date") || "",
          patient_chronic_conditions_summary: "",
          patient_current_treatments_summary: "",
          patient_allergies_history: "",
          patient_other_general_info: "",
          vax_history_doses_count_per_vaccine: fd.get("vax_history_doses_count_per_vaccine") || "",
          vax_history_last_injection_date_per_vaccine: "",
          vax_history_tolerance_adverse_events: "",
          vax_history_status_uncertainty: "",
          vax_history_vaccines_done_abroad: "",
          vax_history_other_flag: false,
          vax_history_other_details: "",
          vax_history_how_information_collected_today: "",
          contraindications_check_clinical_status_today: "",
          contraindications_check_anticoagulants: "non",
          contraindications_check_immunosuppressive_or_immunodepression: "non",
          contraindications_check_severe_allergy_anaphylaxis_history: "non",
          contraindications_check_severe_post_vaccination_reaction_history: "non",
          contraindications_check_progressive_uncontrolled_neurological_pathology: "non",
          contraindications_check_pregnancy_or_postpartum: "",
          contraindications_check_other_flag: false,
          contraindications_check_other_details: "",
          existing_checklists_or_protocols_used: "",
          importance_patient_age_range: "",
          importance_patient_sex: "",
          importance_patient_pregnancy_status_or_project: "",
          importance_patient_profession_risk_exposure: "",
          importance_patient_travel_plan_country_date: "",
          importance_patient_chronic_conditions_summary: "",
          importance_patient_current_treatments_summary: "",
          importance_patient_allergies_history: "",
          patient_general_info_other_must_collect: "",
        };

        try {
          const r = await fetch("/.netlify/functions/diagnostic", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ patient: payload }),
          });

          const text = await r.text();
          let result;

          try {
            result = JSON.parse(text);
            rawJsonEl.textContent = JSON.stringify(result, null, 2);
            renderDiagnostic(result);
            statusEl.textContent = r.ok ? "‚úÖ Diagnostic termin√©" : `‚ùå Erreur HTTP ${r.status}`;
            resultContainer.classList.add("visible");
          } catch {
            rawJsonEl.textContent = text;
            statusEl.textContent = "‚ùå R√©ponse non JSON";
          }
        } catch (err) {
          rawJsonEl.textContent = String(err);
          statusEl.textContent = "‚ùå Erreur r√©seau";
        } finally {
          submitBtn.disabled = false;
        }
      });

      // === RENDERING FUNCTIONS ===

      function renderDiagnostic(result) {
        renderMeta(result.meta, result.patient_input_echo);
        renderRecommendedVaccines(result.recommended_vaccines);
        renderCatchupSchedule(result.catchup_schedule);
        renderContraindications(result.contraindications_and_precautions);
        renderPracticalAdvice(result.practical_advice);
        renderPatientReport(result.patient_report);
        renderGPReport(result.gp_report);
        renderLimitations(result.limitations);
        renderReferences(result.references);
      }

      function renderMeta(meta, patientEcho) {
        const html = `
          <div class="meta-grid">
            <div class="meta-item">
              <strong>Date du diagnostic</strong>
              <div>${formatDate(meta.diagnostic_date_iso)}</div>
            </div>
            <div class="meta-item">
              <strong>Document source</strong>
              <div>${meta.source_document}</div>
            </div>
            <div class="meta-item">
              <strong>Version</strong>
              <div>${meta.version}</div>
            </div>
            <div class="meta-item">
              <strong>Patient</strong>
              <div>${patientEcho.patient_age_range || "‚Äî"} / ${patientEcho.patient_sex || "‚Äî"}</div>
            </div>
            ${
              patientEcho.patient_pregnancy_status_or_project
                ? `<div class="meta-item">
                    <strong>Grossesse</strong>
                    <div>${patientEcho.patient_pregnancy_status_or_project}</div>
                  </div>`
                : ""
            }
            ${
              patientEcho.patient_profession_risk_exposure
                ? `<div class="meta-item">
                    <strong>Profession</strong>
                    <div>${patientEcho.patient_profession_risk_exposure}</div>
                  </div>`
                : ""
            }
          </div>
        `;
        document.getElementById("metaContent").innerHTML = html;
      }

      function renderRecommendedVaccines(vaccines) {
        const section = document.getElementById("vaccinesSection");
        const content = document.getElementById("vaccinesContent");

        if (!vaccines || vaccines.length === 0) {
          section.style.display = "none";
          return;
        }

        section.style.display = "block";
        const html = vaccines
          .map(
            (v) => `
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">${v.vaccine_name}</h3>
              ${getBadgeForActType(v.act_type)}
            </div>
            <div class="card-content">
              <p><strong>Timing:</strong> ${v.timing_label}</p>
              <p><strong>Autoris√© en officine:</strong> ${v.allowed_in_pharmacy}</p>
              <p><strong>Administrable par:</strong> ${v.administerable_by}</p>
              ${
                v.vigilance_points && v.vigilance_points.length > 0
                  ? `<p><strong>Points de vigilance:</strong></p>
                     <ul class="bullet-list">
                       ${v.vigilance_points.map((vp) => `<li>${vp}</li>`).join("")}
                     </ul>`
                  : ""
              }
              ${renderSources(v.sources)}
            </div>
          </div>
        `
          )
          .join("");
        content.innerHTML = html;
      }

      function renderCatchupSchedule(schedule) {
        const section = document.getElementById("catchupSection");
        const content = document.getElementById("catchupContent");

        if (!schedule || schedule.length === 0) {
          section.style.display = "none";
          return;
        }

        section.style.display = "block";
        const html = `
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Vaccin</th>
                  <th>Dose</th>
                  <th>Date propos√©e</th>
                  <th>Intervalle min.</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody>
                ${schedule
                  .map(
                    (item) => `
                  <tr>
                    <td><strong>${item.vaccine_name}</strong></td>
                    <td>Dose ${item.dose_number}</td>
                    <td>${
                      item.proposed_date_iso
                        ? `<strong style="color: var(--primary)">${formatDate(item.proposed_date_iso)}</strong>`
                        : '<span class="badge badge-warning">√Ä planifier</span>'
                    }</td>
                    <td>${item.min_interval_days > 0 ? `${item.min_interval_days} jours` : "‚Äî"}</td>
                    <td>
                      ${item.notes || "‚Äî"}
                      ${renderSources(item.sources, true)}
                    </td>
                  </tr>
                `
                  )
                  .join("")}
              </tbody>
            </table>
          </div>
        `;
        content.innerHTML = html;
      }

      function renderContraindications(items) {
        const section = document.getElementById("contraindicationsSection");
        const content = document.getElementById("contraindicationsContent");

        if (!items || items.length === 0) {
          section.style.display = "none";
          return;
        }

        section.style.display = "block";
        const html = items
          .map(
            (item) => `
          <div class="${getAlertClass(item.severity)}">
            <div class="alert-title">
              ${getBadgeForSeverity(item.severity)} ${item.title}
            </div>
            <p>${item.details}</p>
            ${renderSources(item.sources, true)}
          </div>
        `
          )
          .join("");
        content.innerHTML = html;
      }

      function renderPracticalAdvice(advice) {
        const section = document.getElementById("adviceSection");
        const content = document.getElementById("adviceContent");

        if (!advice || advice.length === 0) {
          section.style.display = "none";
          return;
        }

        section.style.display = "block";
        const html = advice
          .map(
            (item) => `
          <div class="card">
            <h3 class="card-title">${item.title}</h3>
            <ul class="bullet-list">
              ${item.bullets.map((b) => `<li>${b}</li>`).join("")}
            </ul>
            ${renderSources(item.sources)}
          </div>
        `
          )
          .join("");
        content.innerHTML = html;
      }

      function renderPatientReport(report) {
        const section = document.getElementById("patientReportSection");
        const content = document.getElementById("patientReportContent");

        if (!report || !report.bullets || report.bullets.length === 0) {
          section.style.display = "none";
          return;
        }

        section.style.display = "block";
        const html = `
          <div class="card">
            <h3 class="card-title">${report.title || "R√©sum√©"}</h3>
            <ul class="bullet-list">
              ${report.bullets.map((b) => `<li>${b}</li>`).join("")}
            </ul>
            ${renderSources(report.sources)}
          </div>
        `;
        content.innerHTML = html;
      }

      function renderGPReport(report) {
        const section = document.getElementById("gpReportSection");
        const content = document.getElementById("gpReportContent");

        if (!report || !report.bullets || report.bullets.length === 0) {
          section.style.display = "none";
          return;
        }

        section.style.display = "block";
        const html = `
          <div class="card">
            <h3 class="card-title">${report.title || "R√©sum√© professionnel"}</h3>
            <ul class="bullet-list">
              ${report.bullets.map((b) => `<li>${b}</li>`).join("")}
            </ul>
            ${renderSources(report.sources)}
          </div>
        `;
        content.innerHTML = html;
      }

      function renderLimitations(limitations) {
        const section = document.getElementById("limitationsSection");
        const content = document.getElementById("limitationsContent");

        if (!limitations || limitations.length === 0) {
          section.style.display = "none";
          return;
        }

        section.style.display = "block";
        const html = `
          <div class="alert alert-warning">
            <div class="alert-title">Informations non trouv√©es dans le document source</div>
            <ul class="bullet-list">
              ${limitations.map((l) => `<li>${l}</li>`).join("")}
            </ul>
          </div>
        `;
        content.innerHTML = html;
      }

      function renderReferences(references) {
        const section = document.getElementById("referencesSection");
        const content = document.getElementById("referencesContent");

        if (!references || references.length === 0) {
          section.style.display = "none";
          return;
        }

        section.style.display = "block";

        // Group by page
        const byPage = {};
        references.forEach((ref) => {
          if (!byPage[ref.page]) byPage[ref.page] = [];
          byPage[ref.page].push(ref);
        });

        const html = Object.keys(byPage)
          .sort((a, b) => parseInt(a) - parseInt(b))
          .map((page) => {
            const refs = byPage[page];
            return `
            <div class="card">
              <h3 class="card-title">Page ${page}</h3>
              ${refs
                .map(
                  (ref) => `
                <div class="source-item">
                  <strong>${ref.section_hint}:</strong>
                  <span class="source-snippet">"${ref.snippet}"</span>
                </div>
              `
                )
                .join("")}
            </div>
          `;
          })
          .join("");

        content.innerHTML = html;
      }

      // === HELPER FUNCTIONS ===

      function renderSources(sources, inline = false) {
        if (!sources || sources.length === 0) return "";

        const items = sources
          .map(
            (s) =>
              `<div class="source-item"><strong>p. ${s.page}</strong> ‚Äî <span class="source-snippet">"${s.snippet}"</span> <em>(${s.section_hint})</em></div>`
          )
          .join("");

        return inline
          ? `<div style="margin-top: 8px; font-size: 12px; color: var(--light-text);">${items}</div>`
          : `<div class="sources"><div class="sources-label">Sources</div>${items}</div>`;
      }

      function formatDate(isoDate) {
        if (!isoDate) return "‚Äî";
        try {
          const date = new Date(isoDate);
          return date.toLocaleDateString("fr-FR", {
            year: "numeric",
            month: "long",
            day: "numeric",
          });
        } catch {
          return isoDate;
        }
      }

      function getBadgeForActType(type) {
        if (!type) return "";
        const lower = type.toLowerCase();
        if (lower.includes("obligatoire")) return '<span class="badge badge-danger">Obligatoire</span>';
        if (lower.includes("recommand√©")) return '<span class="badge badge-primary">Recommand√©</span>';
        if (lower.includes("rattrapage")) return '<span class="badge badge-warning">Rattrapage</span>';
        return `<span class="badge badge-neutral">${type}</span>`;
      }

      function getBadgeForSeverity(severity) {
        if (!severity) return "";
        const lower = severity.toLowerCase();
        if (lower.includes("majeure")) return '<span class="badge badge-danger">Contre-indication majeure</span>';
        if (lower.includes("pr√©caution")) return '<span class="badge badge-warning">Pr√©caution</span>';
        if (lower.includes("recommandation")) return '<span class="badge badge-info">Recommandation</span>';
        return `<span class="badge badge-neutral">${severity}</span>`;
      }

      function getAlertClass(severity) {
        if (!severity) return "alert alert-info";
        const lower = severity.toLowerCase();
        if (lower.includes("majeure")) return "alert alert-danger";
        if (lower.includes("pr√©caution")) return "alert alert-warning";
        return "alert alert-info";
      }
    </script>
  </body>
</html>
