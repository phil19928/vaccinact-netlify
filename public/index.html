<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VaccinAct ‚Äî Diagnostic</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,600;700&family=Manrope:wght@400;500;600;700&display=swap");

    :root {
      --max: 1200px;
      --bg: #f7f4ef;
      --surface: #fffdf9;
      --ink: #171717;
      --muted: #4c4c4c;
      --light-text: #6a655d;

      --primary: #0f6f5c;
      --primary-dark: #0b5a4a;
      --primary-light: #d1fae5;
      --success: #16a34a;
      --warning: #f59e0b;
      --danger: #dc2626;
      --info: #3b82f6;

      --border: #e3ded5;
      --border-light: #eee6dc;
      --bg-light: #f6f3ee;

      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;

      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 16px 40px rgba(12, 12, 12, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Manrope", sans-serif;
      margin: 0;
      padding: 24px;
      color: var(--ink);
      background: radial-gradient(900px 420px at 10% -10%, #ffe9bf 0, transparent 60%),
        radial-gradient(900px 420px at 90% 0%, #d9f3ec 0, transparent 60%), var(--bg);
      line-height: 1.6;
    }

    .container {
      max-width: var(--max);
      margin: 0 auto;
    }

    /* Header */
    .page-header {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 24px 28px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-lg);
      text-align: center;
    }

    .logo {
      max-width: 200px;
      height: auto;
      margin-bottom: 16px;
    }

    h1 {
      margin: 0;
      font-family: "Fraunces", serif;
      font-size: 32px;
      letter-spacing: 0.2px;
    }

    .required-note {
      font-size: 13px;
      color: var(--muted);
      margin-top: 12px;
    }

    .required-asterisk {
      color: var(--danger);
      margin-left: 2px;
    }

    /* Form Section */
    .form-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 28px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-md);
    }

    /* Accordion */
    .accordion {
      margin-bottom: 16px;
    }

    .accordion-header {
      background: var(--bg-light);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      padding: 16px 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 700;
      font-size: 16px;
      transition: background 0.2s ease;
      user-select: none;
    }

    .accordion-header:hover {
      background: #efe7da;
    }

    .accordion-header.active {
      background: var(--primary-light);
      border-color: var(--primary);
      color: var(--primary-dark);
    }

    .accordion-icon {
      transition: transform 0.3s ease;
      font-size: 20px;
    }

    .accordion-header.active .accordion-icon {
      transform: rotate(180deg);
    }

    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      padding: 0 20px;
    }

    .accordion-content.active {
      max-height: 5000px;
      padding: 24px 20px;
    }

    fieldset {
      border: none;
      padding: 0;
      margin: 24px 0;
    }

    legend {
      font-weight: 700;
      font-size: 15px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 18px;
      row-gap: 20px;
    }

    .col-12 {
      grid-column: span 12;
    }

    .col-6 {
      grid-column: span 6;
    }

    .col-4 {
      grid-column: span 4;
    }

    .col-3 {
      grid-column: span 3;
    }

    label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--ink);
      margin: 0 0 8px;
      line-height: 1.4;
    }

    input[type="text"],
    input[type="month"],
    select,
    textarea {
      width: 100%;
      padding: 11px 12px;
      border: 1px solid #d7d0c7;
      border-radius: 10px;
      font-size: 14px;
      background: #fff;
      font-family: inherit;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(15, 111, 92, 0.18);
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    .hint {
      font-size: 12px;
      color: var(--light-text);
      margin-top: 6px;
      line-height: 1.4;
    }

    /* Chips / Tags */
    .chips-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
      min-height: 40px;
      padding: 8px;
      border: 1px solid #d7d0c7;
      border-radius: 10px;
      background: #fff;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--primary-light);
      color: var(--primary-dark);
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      border: 1px solid var(--primary);
    }

    .chip-remove {
      background: none;
      border: none;
      color: var(--primary-dark);
      cursor: pointer;
      padding: 0;
      font-size: 16px;
      line-height: 1;
      font-weight: 700;
    }

    .chip-remove:hover {
      color: var(--danger);
    }

    .chip-dose-select {
      border: none;
      background: rgba(255, 255, 255, 0.7);
      color: var(--primary-dark);
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }

    /* Multi-select dropdown */
    .multi-select {
      position: relative;
    }

    .multi-select-input {
      cursor: pointer;
    }

    .multi-select-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: var(--shadow-md);
      max-height: 300px;
      overflow-y: auto;
      z-index: 100;
      display: none;
      margin-top: 4px;
    }

    .multi-select-dropdown.active {
      display: block;
    }

    .multi-select-option {
      padding: 10px 14px;
      cursor: pointer;
      transition: background 0.15s ease;
      font-size: 14px;
    }

    .multi-select-option:hover {
      background: var(--bg-light);
    }

    .multi-select-option.selected {
      background: var(--primary-light);
      color: var(--primary-dark);
      font-weight: 600;
    }

    /* Checkbox group */
    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 12px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border: 1px solid var(--border-light);
      border-radius: 8px;
      background: #fafaf9;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .checkbox-item:hover {
      background: var(--bg-light);
      border-color: var(--primary);
    }

    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .checkbox-item label {
      margin: 0;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
    }

    /* Segmented control (Yes/No/Unknown) */
    .segmented-control {
      display: inline-flex;
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      background: white;
    }

    .segmented-option {
      padding: 8px 16px;
      border: none;
      background: white;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s ease;
      border-right: 1px solid var(--border-light);
    }

    .segmented-option:last-child {
      border-right: none;
    }

    .segmented-option:hover {
      background: var(--bg-light);
    }

    .segmented-option.active {
      background: var(--primary);
      color: white;
    }

    /* Buttons */
    button {
      padding: 12px 24px;
      border: 0;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-weight: 700;
      font-size: 15px;
      font-family: inherit;
      background: var(--primary);
      color: #fffdf8;
      box-shadow: 0 10px 20px rgba(15, 111, 92, 0.2);
      transition: transform 0.15s ease, background 0.2s ease;
    }

    button:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: #6b7280;
      box-shadow: 0 10px 20px rgba(107, 114, 128, 0.15);
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .actions {
      display: flex;
      gap: 12px;
      align-items: center;
      margin: 24px 0;
    }

    .status-text {
      font-size: 14px;
      color: var(--light-text);
      font-weight: 500;
    }

    /* Payload preview */
    .payload-preview {
      background: #1e293b;
      color: #e2e8f0;
      border: 1px solid #334155;
      padding: 16px;
      border-radius: var(--radius-md);
      overflow: auto;
      font-family: ui-monospace, monospace;
      font-size: 12px;
      line-height: 1.5;
      max-height: 400px;
      display: none;
    }

    .payload-preview.visible {
      display: block;
    }

    /* Responsive */
    @media (max-width: 768px) {
      body {
        padding: 16px;
      }

      .grid {
        grid-template-columns: 1fr;
      }

      .col-12,
      .col-6,
      .col-4,
      .col-3 {
        grid-column: 1 / -1;
      }

      .checkbox-group {
        grid-template-columns: 1fr;
      }

      h1 {
        font-size: 24px;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      * {
        animation: none !important;
        transition: none !important;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header -->
    <div class="page-header">
      <img src="logo.png" alt="VaccinAct Logo" class="logo" />
      <h1>Diagnostic Vaccinal</h1>
      <p class="required-note"><span class="required-asterisk">*</span> Champs obligatoires</p>
    </div>

    <!-- Form -->
    <div class="form-section">
      <form id="vaccinForm">

        <!-- SECTION MODE RAPIDE -->
        <div class="accordion">
          <div class="accordion-header active" data-target="quick-section">
            <span>üìù Informations essentielles</span>
            <span class="accordion-icon">‚ñº</span>
          </div>
          <div class="accordion-content active" id="quick-section">
            <div class="grid">
              <!-- Age -->
              <div class="col-4">
                <label for="patient_age_range">Tranche d'√¢ge <span class="required-asterisk">*</span></label>
                <select id="patient_age_range" required>
                  <option value="">‚Äî S√©lectionner ‚Äî</option>
                  <option value="0-1">0‚Äì1 an</option>
                  <option value="2-5">2‚Äì5 ans</option>
                  <option value="6-17">6‚Äì17 ans</option>
                  <option value="18-25">18‚Äì25 ans</option>
                  <option value="26-45">26‚Äì45 ans</option>
                  <option value="46-65">46‚Äì65 ans</option>
                  <option value="65+">65+ ans</option>
                </select>
              </div>

              <!-- Sexe -->
              <div class="col-4">
                <label for="patient_sex">Sexe <span class="required-asterisk">*</span></label>
                <select id="patient_sex" required>
                  <option value="">‚Äî S√©lectionner ‚Äî</option>
                  <option value="F">F√©minin</option>
                  <option value="M">Masculin</option>
                  <option value="Autre">Autre</option>
                  <option value="NSP">Non sp√©cifi√©</option>
                </select>
              </div>

              <!-- Grossesse -->
              <div class="col-4">
                <label for="patient_pregnancy">Statut grossesse</label>
                <select id="patient_pregnancy">
                  <option value="">‚Äî S√©lectionner ‚Äî</option>
                  <option value="non">Non</option>
                  <option value="projet">Projet grossesse</option>
                  <option value="enceinte_T1">Enceinte T1</option>
                  <option value="enceinte_T2">Enceinte T2</option>
                  <option value="enceinte_T3">Enceinte T3</option>
                  <option value="postpartum">Post-partum</option>
                  <option value="non_applicable">Non applicable</option>
                  <option value="inconnu">Inconnu</option>
                </select>
              </div>

              <!-- Profession multi-select -->
              <div class="col-12">
                <label>Profession / Exposition aux risques</label>
                <div class="chips-container" id="profession-chips"></div>
                <div class="multi-select">
                  <input type="text" id="profession-search" class="multi-select-input"
                    placeholder="Rechercher et s√©lectionner..." autocomplete="off" />
                  <div class="multi-select-dropdown" id="profession-dropdown">
                    <div class="multi-select-option" data-value="soignant">Soignant</div>
                    <div class="multi-select-option" data-value="creche">Cr√®che / Petite enfance</div>
                    <div class="multi-select-option" data-value="ehpad">EHPAD</div>
                    <div class="multi-select-option" data-value="laboratoire">Laboratoire / Biom√©dical</div>
                    <div class="multi-select-option" data-value="voyage_frequent">Voyage fr√©quent</div>
                    <div class="multi-select-option" data-value="contact_immuno">Contact immunod√©prim√©s</div>
                    <div class="multi-select-option" data-value="contact_animaux">Contact animaux</div>
                    <div class="multi-select-option" data-value="autre">Autre</div>
                  </div>
                </div>
                <input type="text" id="profession-autre" placeholder="Pr√©cisez..."
                  style="display: none; margin-top: 12px;" />
              </div>

              <!-- Voyage structur√© -->
              <div class="col-6">
                <label for="travel-country">Voyage pr√©vu - Pays</label>
                <input type="text" id="travel-country" placeholder="Ex: Br√©sil, Tha√Ølande..." />
              </div>

              <div class="col-6">
                <label for="travel-date">Voyage pr√©vu - Date approximative</label>
                <input type="month" id="travel-date" />
                <div class="hint">
                  <input type="checkbox" id="no-travel" style="width: auto; margin-right: 6px;" />
                  <label for="no-travel" style="display: inline; margin: 0; font-weight: normal;">Pas de voyage
                    pr√©vu</label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SECTION VACCINS (Rapide mode am√©lior√©) -->
        <div class="accordion">
          <div class="accordion-header active" data-target="vaccines-section">
            <span>üíâ Historique vaccinal</span>
            <span class="accordion-icon">‚ñº</span>
          </div>
          <div class="accordion-content active" id="vaccines-section">
            <div class="grid">
              <div class="col-12">
                <label>Vaccins d√©j√† re√ßus</label>
                <div class="chips-container" id="vaccines-chips"></div>
                <div class="multi-select">
                  <input type="text" id="vaccines-search" class="multi-select-input"
                    placeholder="Rechercher un vaccin..." autocomplete="off" />
                  <div class="multi-select-dropdown" id="vaccines-dropdown">
                    <div class="multi-select-option" data-value="DTP">DTP / dTPolio</div>
                    <div class="multi-select-option" data-value="dTcaPolio">dTcaPolio (coqueluche)</div>
                    <div class="multi-select-option" data-value="ROR">ROR (Rougeole-Oreillons-Rub√©ole)</div>
                    <div class="multi-select-option" data-value="Hepatite_B">H√©patite B</div>
                    <div class="multi-select-option" data-value="HPV">HPV (Papillomavirus)</div>
                    <div class="multi-select-option" data-value="Grippe">Grippe</div>
                    <div class="multi-select-option" data-value="Covid19">Covid-19</div>
                    <div class="multi-select-option" data-value="Pneumocoque">Pneumocoque</div>
                    <div class="multi-select-option" data-value="Meningocoque_ACWY">M√©ningocoques ACWY</div>
                    <div class="multi-select-option" data-value="Meningocoque_B">M√©ningocoques B</div>
                    <div class="multi-select-option" data-value="Varicelle">Varicelle</div>
                    <div class="multi-select-option" data-value="Zona">Zona</div>
                    <div class="multi-select-option" data-value="BCG">BCG</div>
                    <div class="multi-select-option" data-value="VRS">VRS</div>
                    <div class="multi-select-option" data-value="Hepatite_A">H√©patite A</div>
                    <div class="multi-select-option" data-value="Fievre_jaune">Fi√®vre jaune</div>
                    <div class="multi-select-option" data-value="Autre">Autre</div>
                  </div>
                </div>
                <div class="hint">S√©lectionnez les vaccins, puis indiquez le nombre de doses pour chacun</div>
              </div>

              <!-- Statut historique -->
              <div class="col-6">
                <label for="vax-status">Statut de l'information</label>
                <select id="vax-status">
                  <option value="">‚Äî S√©lectionner ‚Äî</option>
                  <option value="carnet_ok">Carnet de vaccination OK</option>
                  <option value="carnet_perdu">Carnet perdu</option>
                  <option value="declaratif">D√©claratif</option>
                  <option value="incertain">Incertain</option>
                  <option value="autre">Autre</option>
                </select>
              </div>

              <!-- Source info -->
              <div class="col-6">
                <label for="vax-source">Source de l'information</label>
                <select id="vax-source">
                  <option value="">‚Äî S√©lectionner ‚Äî</option>
                  <option value="carnet">Carnet de vaccination</option>
                  <option value="dmp">DMP / Dossier m√©dical</option>
                  <option value="declaratif">D√©claratif patient</option>
                  <option value="pharmacie">Historique officine</option>
                  <option value="autre">Autre</option>
                </select>
              </div>

              <!-- Vaccins √† l'√©tranger -->
              <div class="col-6">
                <label for="vax-abroad">Vaccins r√©alis√©s √† l'√©tranger</label>
                <select id="vax-abroad">
                  <option value="">‚Äî S√©lectionner ‚Äî</option>
                  <option value="non">Non</option>
                  <option value="oui">Oui</option>
                  <option value="inconnu">Inconnu</option>
                </select>
              </div>

              <div class="col-6" id="abroad-country-wrapper" style="display: none;">
                <label for="abroad-country">Pays des vaccinations</label>
                <input type="text" id="abroad-country" placeholder="Ex: √âtats-Unis, Maroc..." />
              </div>

              <!-- Tol√©rance -->
              <div class="col-6">
                <label for="vax-tolerance">Tol√©rance vaccinale</label>
                <select id="vax-tolerance">
                  <option value="">‚Äî S√©lectionner ‚Äî</option>
                  <option value="ras">RAS (rien √† signaler)</option>
                  <option value="reaction_locale">R√©action locale</option>
                  <option value="fievre">Fi√®vre</option>
                  <option value="allergie">Allergie</option>
                  <option value="anaphylaxie">Anaphylaxie</option>
                  <option value="autre">Autre</option>
                </select>
              </div>

              <div class="col-6" id="tolerance-details-wrapper" style="display: none;">
                <label for="tolerance-details">D√©tails tol√©rance</label>
                <input type="text" id="tolerance-details" placeholder="Pr√©cisez..." />
              </div>
            </div>
          </div>
        </div>

        <!-- SECTION CONTEXTE M√âDICAL (Mode Avanc√©) -->
        <div class="accordion">
          <div class="accordion-header" data-target="medical-section">
            <span>üè• Contexte m√©dical (optionnel)</span>
            <span class="accordion-icon">‚ñº</span>
          </div>
          <div class="accordion-content" id="medical-section">

            <!-- Pathologies chroniques -->
            <fieldset>
              <legend>Pathologies chroniques</legend>
              <div class="checkbox-group" id="chronic-conditions">
                <div class="checkbox-item">
                  <input type="checkbox" id="cond-immunodepression" value="immunod√©pression" />
                  <label for="cond-immunodepression">Immunod√©pression</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="cond-asplenie" value="aspl√©nie" />
                  <label for="cond-asplenie">Aspl√©nie</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="cond-diabete" value="diab√®te" />
                  <label for="cond-diabete">Diab√®te</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="cond-bpco" value="BPCO/asthme s√©v√®re" />
                  <label for="cond-bpco">BPCO / Asthme s√©v√®re</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="cond-renal" value="insuffisance r√©nale" />
                  <label for="cond-renal">Insuffisance r√©nale</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="cond-cardio" value="cardiopathie" />
                  <label for="cond-cardio">Cardiopathie</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="cond-hepatique" value="maladie h√©patique" />
                  <label for="cond-hepatique">Maladie h√©patique</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="cond-vih" value="VIH" />
                  <label for="cond-vih">VIH</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="cond-cancer" value="cancer en traitement" />
                  <label for="cond-cancer">Cancer en traitement</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="cond-greffe" value="greffe" />
                  <label for="cond-greffe">Greffe</label>
                </div>
              </div>
              <div class="col-12" style="margin-top: 16px;">
                <input type="text" id="chronic-autre" placeholder="Autre pathologie..." />
              </div>
            </fieldset>

            <!-- Traitements -->
            <fieldset>
              <legend>Traitements en cours</legend>
              <div class="checkbox-group" id="treatments">
                <div class="checkbox-item">
                  <input type="checkbox" id="treat-immuno" value="immunosuppresseurs" />
                  <label for="treat-immuno">Immunosuppresseurs</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="treat-cortico" value="cortico√Ødes prolong√©s" />
                  <label for="treat-cortico">Cortico√Ødes prolong√©s</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="treat-anticoag" value="anticoagulants" />
                  <label for="treat-anticoag">Anticoagulants</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="treat-bio" value="bioth√©rapies" />
                  <label for="treat-bio">Bioth√©rapies</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="treat-chimio" value="chimioth√©rapie" />
                  <label for="treat-chimio">Chimioth√©rapie</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="treat-cd20" value="anti-CD20" />
                  <label for="treat-cd20">Anti-CD20</label>
                </div>
              </div>
              <div class="col-12" style="margin-top: 16px;">
                <input type="text" id="treatment-autre" placeholder="Autre traitement..." />
              </div>
            </fieldset>

            <!-- Allergies -->
            <div class="grid">
              <div class="col-6">
                <label for="allergies">Allergies</label>
                <select id="allergies">
                  <option value="">‚Äî S√©lectionner ‚Äî</option>
                  <option value="aucune">Aucune connue</option>
                  <option value="medicamenteuse">Allergie m√©dicamenteuse</option>
                  <option value="vaccinale">Allergie vaccinale</option>
                  <option value="anaphylaxie">Anaphylaxie</option>
                  <option value="inconnu">Inconnu</option>
                </select>
              </div>

              <div class="col-6" id="allergy-details-wrapper" style="display: none;">
                <label for="allergy-details">D√©tails allergies</label>
                <input type="text" id="allergy-details" placeholder="Pr√©cisez..." />
              </div>

              <div class="col-12">
                <label for="other-info">Autres informations utiles</label>
                <textarea id="other-info" placeholder="Contexte particulier, ant√©c√©dents..."></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- SECTION CONTRE-INDICATIONS (Mode Avanc√©) -->
        <div class="accordion">
          <div class="accordion-header" data-target="ci-section">
            <span>‚ö†Ô∏è Contre-indications & Pr√©cautions (optionnel)</span>
            <span class="accordion-icon">‚ñº</span>
          </div>
          <div class="accordion-content" id="ci-section">
            <div class="grid">
              <div class="col-12">
                <label>√âtat clinique aujourd'hui</label>
                <select id="clinical-status">
                  <option value="">‚Äî S√©lectionner ‚Äî</option>
                  <option value="OK">OK</option>
                  <option value="fievre_moderee">Fi√®vre mod√©r√©e</option>
                  <option value="fievre_severe">Fi√®vre s√©v√®re</option>
                  <option value="infection_aigue">Infection aigu√´</option>
                  <option value="autre">Autre</option>
                </select>
              </div>

              <!-- Checklist CI avec segmented controls -->
              <div class="col-12">
                <fieldset>
                  <legend>V√©rification contre-indications</legend>

                  <div style="margin-bottom: 16px;">
                    <label style="display: inline-block; width: 300px; margin-right: 12px;">Anticoagulants</label>
                    <div class="segmented-control" data-field="ci-anticoag">
                      <button type="button" class="segmented-option" data-value="non">Non</button>
                      <button type="button" class="segmented-option active" data-value="oui">Oui</button>
                      <button type="button" class="segmented-option" data-value="inconnu">Inconnu</button>
                    </div>
                  </div>

                  <div style="margin-bottom: 16px;">
                    <label style="display: inline-block; width: 300px; margin-right: 12px;">Immunosuppression /
                      Immunod√©pression</label>
                    <div class="segmented-control" data-field="ci-immuno">
                      <button type="button" class="segmented-option active" data-value="non">Non</button>
                      <button type="button" class="segmented-option" data-value="oui">Oui</button>
                      <button type="button" class="segmented-option" data-value="inconnu">Inconnu</button>
                    </div>
                  </div>

                  <div style="margin-bottom: 16px;">
                    <label style="display: inline-block; width: 300px; margin-right: 12px;">Allergie s√©v√®re /
                      Anaphylaxie</label>
                    <div class="segmented-control" data-field="ci-allergy">
                      <button type="button" class="segmented-option active" data-value="non">Non</button>
                      <button type="button" class="segmented-option" data-value="oui">Oui</button>
                      <button type="button" class="segmented-option" data-value="inconnu">Inconnu</button>
                    </div>
                  </div>

                  <div style="margin-bottom: 16px;">
                    <label style="display: inline-block; width: 300px; margin-right: 12px;">R√©action s√©v√®re
                      post-vaccinale</label>
                    <div class="segmented-control" data-field="ci-postrxn">
                      <button type="button" class="segmented-option active" data-value="non">Non</button>
                      <button type="button" class="segmented-option" data-value="oui">Oui</button>
                      <button type="button" class="segmented-option" data-value="inconnu">Inconnu</button>
                    </div>
                  </div>

                  <div style="margin-bottom: 16px;">
                    <label style="display: inline-block; width: 300px; margin-right: 12px;">Pathologie neurologique
                      progressive</label>
                    <div class="segmented-control" data-field="ci-neuro">
                      <button type="button" class="segmented-option active" data-value="non">Non</button>
                      <button type="button" class="segmented-option" data-value="oui">Oui</button>
                      <button type="button" class="segmented-option" data-value="inconnu">Inconnu</button>
                    </div>
                  </div>
                </fieldset>
              </div>

              <div class="col-12">
                <label for="protocols-used">Protocoles / Checklists utilis√©s</label>
                <input type="text" id="protocols-used" placeholder="Ex: Protocole interne, HAS..." />
              </div>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="actions">
          <button id="submitBtn" type="submit">üîç Lancer le diagnostic</button>
          <button id="previewBtn" type="button" class="btn-secondary">üëÅÔ∏è Aper√ßu payload</button>
          <span id="status" class="status-text"></span>
        </div>

        <!-- Payload Preview -->
        <div class="accordion" style="margin-top: 20px;">
          <div class="accordion-header" data-target="payload-section">
            <span>üîç Aper√ßu du payload (debug)</span>
            <span class="accordion-icon">‚ñº</span>
          </div>
          <div class="accordion-content" id="payload-section">
            <pre id="payloadPreview" class="payload-preview"></pre>
          </div>
        </div>

      </form>
    </div>

    <!-- Result sections (hidden initially, will be populated after submission) -->
    <div id="resultContainer" style="display: none;">
      <!-- Same result sections as before -->
      <div class="form-section">
        <h2>‚úÖ R√©sultat du diagnostic</h2>
        <pre id="rawResult"
          style="background: #1e293b; color: #e2e8f0; padding: 16px; border-radius: 12px; overflow: auto; max-height: 600px;"></pre>
      </div>
    </div>

  </div>

  <script>
    // ===== MULTI-SELECT COMPONENT =====
    class MultiSelect {
      constructor(searchInputId, dropdownId, chipsContainerId, options = {}) {
        this.searchInput = document.getElementById(searchInputId);
        this.dropdown = document.getElementById(dropdownId);
        this.chipsContainer = document.getElementById(chipsContainerId);
        this.selectedItems = new Map(); // value => {label, doses}
        this.showDoses = options.showDoses || false;

        this.init();
      }

      init() {
        // Toggle dropdown on focus
        this.searchInput.addEventListener('focus', () => {
          this.dropdown.classList.add('active');
        });

        // Filter options on type
        this.searchInput.addEventListener('input', (e) => {
          this.filterOptions(e.target.value);
        });

        // Close dropdown on click outside
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.multi-select')) {
            this.dropdown.classList.remove('active');
          }
        });

        // Handle option selection
        this.dropdown.querySelectorAll('.multi-select-option').forEach(option => {
          option.addEventListener('click', (e) => {
            const value = e.target.dataset.value;
            const label = e.target.textContent;

            if (this.selectedItems.has(value)) {
              this.removeItem(value);
            } else {
              this.addItem(value, label);
            }

            this.searchInput.value = '';
            this.searchInput.focus();
          });
        });
      }

      filterOptions(query) {
        const lowerQuery = query.toLowerCase();
        this.dropdown.querySelectorAll('.multi-select-option').forEach(option => {
          const text = option.textContent.toLowerCase();
          option.style.display = text.includes(lowerQuery) ? 'block' : 'none';
        });
      }

      addItem(value, label) {
        this.selectedItems.set(value, { label, doses: this.showDoses ? '1' : null });
        this.renderChips();
        this.updateDropdownState();
      }

      removeItem(value) {
        this.selectedItems.delete(value);
        this.renderChips();
        this.updateDropdownState();
      }

      updateDropdownState() {
        this.dropdown.querySelectorAll('.multi-select-option').forEach(option => {
          const value = option.dataset.value;
          if (this.selectedItems.has(value)) {
            option.classList.add('selected');
          } else {
            option.classList.remove('selected');
          }
        });
      }

      renderChips() {
        this.chipsContainer.innerHTML = '';

        if (this.selectedItems.size === 0) {
          this.chipsContainer.innerHTML = '<span style="color: #9ca3af; font-size: 13px;">Aucune s√©lection</span>';
          return;
        }

        this.selectedItems.forEach((data, value) => {
          const chip = document.createElement('div');
          chip.className = 'chip';

          let chipHTML = `<span>${data.label}</span>`;

          if (this.showDoses) {
            chipHTML += `
              <select class="chip-dose-select" data-vaccine="${value}" onclick="event.stopPropagation()">
                <option value="0" ${data.doses === '0' ? 'selected' : ''}>0</option>
                <option value="1" ${data.doses === '1' ? 'selected' : ''}>1</option>
                <option value="2" ${data.doses === '2' ? 'selected' : ''}>2</option>
                <option value="3" ${data.doses === '3' ? 'selected' : ''}>3</option>
                <option value="4" ${data.doses === '4' ? 'selected' : ''}>4</option>
                <option value="5" ${data.doses === '5' ? 'selected' : ''}>5</option>
                <option value="6" ${data.doses === '6' ? 'selected' : ''}>6</option>
                <option value="annuel" ${data.doses === 'annuel' ? 'selected' : ''}>Annuel</option>
                <option value="inconnu" ${data.doses === 'inconnu' ? 'selected' : ''}>?</option>
              </select>
            `;
          }

          chipHTML += `<button type="button" class="chip-remove" data-value="${value}">√ó</button>`;
          chip.innerHTML = chipHTML;

          // Handle dose change
          if (this.showDoses) {
            chip.querySelector('.chip-dose-select').addEventListener('change', (e) => {
              const item = this.selectedItems.get(value);
              item.doses = e.target.value;
              this.selectedItems.set(value, item);
            });
          }

          // Handle remove
          chip.querySelector('.chip-remove').addEventListener('click', () => {
            this.removeItem(value);
          });

          this.chipsContainer.appendChild(chip);
        });
      }

      getSelectedValues() {
        return Array.from(this.selectedItems.keys());
      }

      getSelectedWithDoses() {
        const result = {};
        this.selectedItems.forEach((data, value) => {
          result[value] = data.doses || '1';
        });
        return result;
      }

      getFormattedString() {
        if (this.selectedItems.size === 0) return '';

        const parts = [];
        this.selectedItems.forEach((data, value) => {
          if (this.showDoses) {
            parts.push(`${data.label}: ${data.doses}`);
          } else {
            parts.push(data.label);
          }
        });
        return parts.join('; ');
      }
    }

    // Initialize components
    const professionMultiSelect = new MultiSelect(
      'profession-search',
      'profession-dropdown',
      'profession-chips'
    );

    const vaccinesMultiSelect = new MultiSelect(
      'vaccines-search',
      'vaccines-dropdown',
      'vaccines-chips',
      { showDoses: true }
    );

    // ===== ACCORDION =====
    document.querySelectorAll('.accordion-header').forEach(header => {
      header.addEventListener('click', () => {
        const targetId = header.dataset.target;
        const content = document.getElementById(targetId);
        const isActive = header.classList.contains('active');

        header.classList.toggle('active');
        content.classList.toggle('active');
      });
    });

    // ===== SEGMENTED CONTROLS =====
    document.querySelectorAll('.segmented-control').forEach(control => {
      control.querySelectorAll('.segmented-option').forEach(option => {
        option.addEventListener('click', (e) => {
          e.preventDefault();
          control.querySelectorAll('.segmented-option').forEach(opt => opt.classList.remove('active'));
          option.classList.add('active');
        });
      });
    });

    // ===== CONDITIONAL FIELDS =====
    // Profession autre
    professionMultiSelect.searchInput.addEventListener('input', () => {
      const hasAutre = professionMultiSelect.getSelectedValues().includes('autre');
      document.getElementById('profession-autre').style.display = hasAutre ? 'block' : 'none';
    });

    // Vaccines abroad country
    document.getElementById('vax-abroad').addEventListener('change', (e) => {
      document.getElementById('abroad-country-wrapper').style.display =
        e.target.value === 'oui' ? 'block' : 'none';
    });

    // Vaccine tolerance details
    document.getElementById('vax-tolerance').addEventListener('change', (e) => {
      const showDetails = ['allergie', 'anaphylaxie', 'autre'].includes(e.target.value);
      document.getElementById('tolerance-details-wrapper').style.display =
        showDetails ? 'block' : 'none';
    });

    // Allergy details
    document.getElementById('allergies').addEventListener('change', (e) => {
      const showDetails = !['', 'aucune', 'inconnu'].includes(e.target.value);
      document.getElementById('allergy-details-wrapper').style.display =
        showDetails ? 'block' : 'none';
    });

    // ===== PAYLOAD BUILDER =====
    function buildPayload() {
      // Get selected vaccines with doses
      const vaccinesWithDoses = vaccinesMultiSelect.getSelectedWithDoses();
      const vaccinesList = Object.keys(vaccinesWithDoses);

      // Build vaccines string
      const vaccinesStr = vaccinesList.map(v => `${v}: ${vaccinesWithDoses[v]}`).join('; ');

      // Build profession string
      const professionValues = professionMultiSelect.getSelectedValues();
      let professionStr = professionValues.filter(v => v !== 'autre').join(', ');
      const autreProf = document.getElementById('profession-autre').value.trim();
      if (professionValues.includes('autre') && autreProf) {
        professionStr += (professionStr ? ', ' : '') + autreProf;
      }
      if (!professionStr) professionStr = '';

      // Travel
      const travelCountry = document.getElementById('travel-country').value.trim();
      const travelDate = document.getElementById('travel-date').value;
      const noTravel = document.getElementById('no-travel').checked;
      let travelStr = '';
      if (!noTravel && (travelCountry || travelDate)) {
        const parts = [];
        if (travelCountry) parts.push(travelCountry);
        if (travelDate) {
          const [year, month] = travelDate.split('-');
          const monthNames = ['janv', 'f√©vr', 'mars', 'avr', 'mai', 'juin', 'juil', 'ao√ªt', 'sept', 'oct', 'nov', 'd√©c'];
          parts.push(`${monthNames[parseInt(month) - 1]} ${year}`);
        }
        travelStr = parts.join(', ');
      }

      // Chronic conditions
      const chronicChecked = Array.from(document.querySelectorAll('#chronic-conditions input:checked'))
        .map(cb => cb.value);
      const chronicAutre = document.getElementById('chronic-autre').value.trim();
      let chronicStr = chronicChecked.join(', ');
      if (chronicAutre) {
        chronicStr += (chronicStr ? ', ' : '') + chronicAutre;
      }

      // Treatments
      const treatmentChecked = Array.from(document.querySelectorAll('#treatments input:checked'))
        .map(cb => cb.value);
      const treatmentAutre = document.getElementById('treatment-autre').value.trim();
      let treatmentStr = treatmentChecked.join(', ');
      if (treatmentAutre) {
        treatmentStr += (treatmentStr ? ', ' : '') + treatmentAutre;
      }

      // Allergies
      const allergyType = document.getElementById('allergies').value;
      const allergyDetails = document.getElementById('allergy-details').value.trim();
      let allergyStr = '';
      if (allergyType && allergyType !== '') {
        allergyStr = allergyType;
        if (allergyDetails) allergyStr += ': ' + allergyDetails;
      }

      // Vaccines abroad
      const vaxAbroad = document.getElementById('vax-abroad').value;
      let vaxAbroadStr = vaxAbroad;
      if (vaxAbroad === 'oui') {
        const country = document.getElementById('abroad-country').value.trim();
        if (country) vaxAbroadStr += ' (' + country + ')';
      }

      // Tolerance
      const tolerance = document.getElementById('vax-tolerance').value;
      let toleranceStr = tolerance;
      if (['allergie', 'anaphylaxie', 'autre'].includes(tolerance)) {
        const details = document.getElementById('tolerance-details').value.trim();
        if (details) toleranceStr += ': ' + details;
      }

      // Segmented controls for CI
      function getSegmentedValue(field) {
        const control = document.querySelector(`.segmented-control[data-field="${field}"]`);
        const active = control?.querySelector('.segmented-option.active');
        return active?.dataset.value || 'non';
      }

      const payload = {
        // Essential info
        patient_age_range: document.getElementById('patient_age_range').value,
        patient_sex: document.getElementById('patient_sex').value,
        patient_pregnancy_status_or_project: document.getElementById('patient_pregnancy').value,
        patient_profession_risk_exposure: professionStr,
        patient_travel_plan_country_date: travelStr,

        // Medical context
        patient_chronic_conditions_summary: chronicStr,
        patient_current_treatments_summary: treatmentStr,
        patient_allergies_history: allergyStr,
        patient_other_general_info: document.getElementById('other-info').value.trim(),

        // Vaccines
        vax_history_doses_count_per_vaccine: vaccinesStr,
        vax_history_last_injection_date_per_vaccine: '', // Could be enhanced with date inputs
        vax_history_tolerance_adverse_events: toleranceStr,
        vax_history_status_uncertainty: document.getElementById('vax-status').value,
        vax_history_vaccines_done_abroad: vaxAbroadStr,
        vax_history_other_flag: false,
        vax_history_other_details: '',
        vax_history_how_information_collected_today: document.getElementById('vax-source').value,

        // CI checks
        contraindications_check_clinical_status_today: document.getElementById('clinical-status').value,
        contraindications_check_anticoagulants: getSegmentedValue('ci-anticoag'),
        contraindications_check_immunosuppressive_or_immunodepression: getSegmentedValue('ci-immuno'),
        contraindications_check_severe_allergy_anaphylaxis_history: getSegmentedValue('ci-allergy'),
        contraindications_check_severe_post_vaccination_reaction_history: getSegmentedValue('ci-postrxn'),
        contraindications_check_progressive_uncontrolled_neurological_pathology: getSegmentedValue('ci-neuro'),
        contraindications_check_pregnancy_or_postpartum: document.getElementById('patient_pregnancy').value,
        contraindications_check_other_flag: false,
        contraindications_check_other_details: '',
        existing_checklists_or_protocols_used: document.getElementById('protocols-used').value.trim(),

        // Importance fields (empty for now, could be added)
        importance_patient_age_range: '',
        importance_patient_sex: '',
        importance_patient_pregnancy_status_or_project: '',
        importance_patient_profession_risk_exposure: '',
        importance_patient_travel_plan_country_date: '',
        importance_patient_chronic_conditions_summary: '',
        importance_patient_current_treatments_summary: '',
        importance_patient_allergies_history: '',
        patient_general_info_other_must_collect: ''
      };

      return payload;
    }

    // ===== PREVIEW PAYLOAD =====
    document.getElementById('previewBtn').addEventListener('click', () => {
      const payload = buildPayload();
      const preview = document.getElementById('payloadPreview');
      preview.textContent = JSON.stringify(payload, null, 2);
      preview.classList.add('visible');

      // Expand payload section
      const payloadHeader = document.querySelector('[data-target="payload-section"]');
      const payloadContent = document.getElementById('payload-section');
      payloadHeader.classList.add('active');
      payloadContent.classList.add('active');

      // Scroll to preview
      preview.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    });

    // ===== FORM SUBMISSION =====
    document.getElementById('vaccinForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = document.getElementById('submitBtn');
      const statusEl = document.getElementById('status');

      submitBtn.disabled = true;
      statusEl.textContent = 'üîÑ Appel en cours...';

      const payload = buildPayload();

      try {
        const response = await fetch('/.netlify/functions/diagnostic', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ patient: payload })
        });

        const text = await response.text();
        let result;

        try {
          result = JSON.parse(text);
          document.getElementById('rawResult').textContent = JSON.stringify(result, null, 2);
          document.getElementById('resultContainer').style.display = 'block';
          document.getElementById('resultContainer').scrollIntoView({ behavior: 'smooth' });
          statusEl.textContent = response.ok ? '‚úÖ Diagnostic termin√©' : `‚ùå Erreur HTTP ${response.status}`;
        } catch {
          document.getElementById('rawResult').textContent = text;
          statusEl.textContent = '‚ùå R√©ponse non JSON';
        }
      } catch (err) {
        document.getElementById('rawResult').textContent = String(err);
        statusEl.textContent = '‚ùå Erreur r√©seau';
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
</body>

</html>